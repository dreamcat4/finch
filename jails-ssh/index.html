<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Finch - Jails Ssh</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="author" content="Dreamcat4">

    <!-- Le HTML5 shim, for IE6-8 support of HTML elements -->
    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <!-- google_prettify/sons-of-obsidian.css -->
    <!-- google_prettify/desert.css -->
    <!-- google_prettify/sunburst.css -->
    <!-- google_prettify/twitter-bootstrap.css -->
    <!-- google_prettify/default.css -->

<link href='/finch/assets/stylesheets/bootstrap.min-5534befd4bd1fd0a071242cecfe33975.css' type='text/css' rel='stylesheet' media='all'>
<link href='/finch/assets/stylesheets/poole-3c3695b40c100cdb0e4db7753b840b57.css' type='text/css' rel='stylesheet' media='all'>
<link href='/finch/assets/stylesheets/style-cf56b256a9bd3b065ef200cb5c12edb6.css' type='text/css' rel='stylesheet' media='all'>
<link href='/finch/assets/stylesheets/google_prettify/default-twitter-merge-fba10b1d8b0c64b52b9995d391059367.css' type='text/css' rel='stylesheet' media='all'>
    <!-- Favicon and touch icons -->
    <link rel="shortcut icon" href="/finch/assets/media/favicon.ico">
    <!-- <link rel="apple-touch-icon" href="media/apple-touch-icon.png"> -->
    <!-- <link rel="apple-touch-icon" sizes="72x72" href="media/apple-touch-icon-72x72.png"> -->
    <!-- <link rel="apple-touch-icon" sizes="114x114" href="media/apple-touch-icon-114x114.png"> -->
 
  </head>

  <body class="theme-base-08">

    <div class="sidebar">
      <div class="container sidebar-sticky">
    
        <div class="sidebar-about">
    
              <h1 style="margin-bottom: -10px;">
                <a class="sidebar-nav-item" href="/finch">Finch</a>
              </h1>
    
          <!-- <p class="lead">FreeBSD... in a chroot!</p> -->
    
          <p class="lead">Freebsd... <strong><i>in a chroot!</i></strong></p>
          <!-- <p class="lead">Freebsd <strong><i>in a chroot!</i></strong></p> -->
    
          <!-- <div class="lead">Freebsd... <strong></div>
            <div class="lead"><i>&nbsp&nbsp&nbsp&nbsp&nbspin a chroot!</i></strong></div> -->
    
        </div>
    
        <ul class="sidebar-nav">
    
                <li class="sidebar-nav-item"><a href="/finch/install">Install</a></li>
                <li class="sidebar-nav-item"><a href="/finch/usage">Usage</a></li>
                <li class="sidebar-nav-item"><a href="/finch/manpage">Manpage</a></li>
                <li class="sidebar-nav-item"><a href="/finch/faq">FAQ</a></li>
                <li class="sidebar-nav-item"><a href="/finch/jails-how-to">Jails How To</a></li>
                <li class="sidebar-nav-item"><a href="/finch/jails-ip-addresses">Jails Ip Addresses</a></li>
                <li>
                  <a href="/finch/jails-ssh" class="sidebar-nav-item-active">Jails Ssh</a>
                </li>
                <li class="sidebar-nav-item"><a href="/finch/mounting-filesystems">Mounting Filesystems</a></li>
                <li class="sidebar-nav-item"><a href="/finch/qjail-reference">Qjail Reference</a></li>
                <li class="sidebar-nav-item"><a href="/finch/upgrading">Upgrading</a></li>
                <li class="sidebar-nav-item"><a href="/finch/support">Support</a></li>
    
              <!-- <li><a href="/finch/faq">FAQ</a></li> -->
              <!-- <li class="sidebar-nav-item"><a href="/finch/faq">FAQ</a></li> -->
              <!-- <li><a href="/finch/finch-8">Finch 8</a></li> -->
              <!-- <li class="sidebar-nav-item"><a href="/finch/finch-8">Finch 8</a></li> -->
              <!-- <li><a href="/finch">Index</a></li> -->
              <!-- <li class="sidebar-nav-item"><a href="/finch">Index</a></li> -->
              <!-- <li><a href="/finch/install">Install</a></li> -->
              <!-- <li class="sidebar-nav-item"><a href="/finch/install">Install</a></li> -->
              <!-- <li><a href="/finch/jails-how-to">Jails How To</a></li> -->
              <!-- <li class="sidebar-nav-item"><a href="/finch/jails-how-to">Jails How To</a></li> -->
              <!-- <li><a href="/finch/jails-ip-addresses">Jails Ip Addresses</a></li> -->
              <!-- <li class="sidebar-nav-item"><a href="/finch/jails-ip-addresses">Jails Ip Addresses</a></li> -->
              <!-- <li class="active"><a href="/finch/jails-ssh" class="active">Jails Ssh</a></li> -->
              <!-- <li class="sidebar-nav-item-active"> -->
              <!-- <li>
                <a href="/finch/jails-ssh" class="sidebar-nav-item-active">Jails Ssh</a>
              </li> -->
              <!-- <li><a href="/finch/manpage">Manpage</a></li> -->
              <!-- <li class="sidebar-nav-item"><a href="/finch/manpage">Manpage</a></li> -->
              <!-- <li><a href="/finch/mounting-filesystems">Mounting Filesystems</a></li> -->
              <!-- <li class="sidebar-nav-item"><a href="/finch/mounting-filesystems">Mounting Filesystems</a></li> -->
              <!-- <li><a href="/finch/portsnap_override-8">Portsnap_override 8</a></li> -->
              <!-- <li class="sidebar-nav-item"><a href="/finch/portsnap_override-8">Portsnap_override 8</a></li> -->
              <!-- <li><a href="/finch/qjail-reference">Qjail Reference</a></li> -->
              <!-- <li class="sidebar-nav-item"><a href="/finch/qjail-reference">Qjail Reference</a></li> -->
              <!-- <li><a href="/finch/support">Support</a></li> -->
              <!-- <li class="sidebar-nav-item"><a href="/finch/support">Support</a></li> -->
              <!-- <li><a href="/finch/upgrading">Upgrading</a></li> -->
              <!-- <li class="sidebar-nav-item"><a href="/finch/upgrading">Upgrading</a></li> -->
              <!-- <li><a href="/finch/usage">Usage</a></li> -->
              <!-- <li class="sidebar-nav-item"><a href="/finch/usage">Usage</a></li> -->
    
              <!-- <a href="https://github.com/dreamcat4/finch/issues">Bugtracker</a> -->
    
                <!-- <li class="sidebar-nav-item{% if page.url == node.url %} active{% endif %}"> -->
    
    
    
                  <!-- <a href=""></a> -->
    
                  <!-- 
                    
                      <li><a href="/finch/faq">FAQ</a></li>
                    
                  
                    
                      <li><a href="/finch/finch-8">Finch 8</a></li>
                    
                  
                    
                      <li><a href="/finch">Index</a></li>
                    
                  
                    
                      <li><a href="/finch/install">Install</a></li>
                    
                  
                    
                      <li><a href="/finch/jails-how-to">Jails How To</a></li>
                    
                  
                    
                      <li><a href="/finch/jails-ip-addresses">Jails Ip Addresses</a></li>
                    
                  
                      <li class="active"><a href="/finch/jails-ssh" class="active">Jails Ssh</a></li>
                    
                    
                  
                    
                      <li><a href="/finch/manpage">Manpage</a></li>
                    
                  
                    
                      <li><a href="/finch/mounting-filesystems">Mounting Filesystems</a></li>
                    
                  
                    
                      <li><a href="/finch/portsnap_override-8">Portsnap_override 8</a></li>
                    
                  
                    
                      <li><a href="/finch/qjail-reference">Qjail Reference</a></li>
                    
                  
                    
                      <li><a href="/finch/support">Support</a></li>
                    
                  
                    
                      <li><a href="/finch/upgrading">Upgrading</a></li>
                    
                  
                    
                      <li><a href="/finch/usage">Usage</a></li>
                    
                   -->
    
    
                </li>
              <!-- {% endif %}
            {% endif %}
          {% endfor %} -->
    
          <!-- <li class="sidebar-nav-item"><a href="dreamcat4/finch/archive/v.zip">Download</a></li> -->
          <!-- <li class="sidebar-nav-item"><a href="https://github.com/dreamcat4/finch">GitHub Project</a></li> -->
          <!-- <li class="sidebar-nav-item">Currently v</li> -->
    
          <!-- <li class="sidebar-nav-item"><a href="https://github.com/dreamcat4/finch">GitHub Project</a></li> -->
          
          <p></p>
          <!-- <p></p> -->
        </ul>
        <!-- <p> -->
        <p>
          <!-- <class="crumbline" style="color: #515151; font-size: 16px; font-style: italic; font-weight: 400;" href="https://github.com/dreamcat4/finch">GitHub Project</a> -->
          <!-- <a class="sidebar-nav" class="crumbline" style="color: #515151; font-size: 16px; font-style: italic; font-weight: 400;" href="https://github.com/dreamcat4/finch">GitHub Project</a> -->
    
          <!-- <a class="sidebar-nav" class="crumbline" style="color: #515151; font-size: 16px; font-style: italic; font-weight: 400;" href="#toc_0">Back to Top</a> -->
    
          <a class="sidebar-nav" class="crumbline" style="color: #515151; font-size: 16px; font-style: italic; font-weight: 400;" href="/finch/jails-ssh">Back to Top</a>
    
          <!-- © 2014. All rights reserved. -->
        </p>
    
        <!-- <p>&copy; {--{ site.time | date: '%Y' }--}. All rights reserved.</p> -->
      </div>
    </div>
    

    <div class="navbar">
      <div class="navbar-inner">
        <!-- <div class="container-narrow"> -->
          <!-- <a class="brand" href="/finch/">Finch</a> -->
    
          <!-- <p class="navbar-left"> -->
          <div class="navbar-left">
    
            <!-- Project hosted on Github <a href="https://github.com/dreamcat4/finch">dreamcat4/finch</a> -->
    
            <ul class="nav">
                  <li><a href="/finch">Home</a></li>
    
                
                  <li><a href="/finch/manpage">Manpage</a></li>
                
                
                  <li><a href="/finch/install">Install</a></li>
                
                
                  <li><a href="/finch/faq">FAQ</a></li>
                
    
            </ul>
    
          <!-- </p> -->
          </div>
    
    
          <!-- <p class="footer-center">
          </p> -->
    
          <!-- <p class="navbar-right"> -->
          <div class="navbar-right">
    
            <!-- &copy; Dreamcat4 2014,  -->
            <!-- FreeBSD Licensing terms. -->
    
    
            <ul class="nav">
    
                
                  <li><a href="/finch/jails-how-to">Jails How To</a></li>
                
                
                  <li><a href="/finch/upgrading">Upgrading</a></li>
                
                
                  <li><a href="/finch/support">Support</a></li>
                
    
              <!--  -->
    
              <!-- 
                
                  <li><a href="/finch/faq">FAQ</a></li>
                
              
                
                  <li><a href="/finch/finch-8">Finch 8</a></li>
                
              
                
                  <li><a href="/finch">Index</a></li>
                
              
                
                  <li><a href="/finch/install">Install</a></li>
                
              
                
                  <li><a href="/finch/jails-how-to">Jails How To</a></li>
                
              
                
                  <li><a href="/finch/jails-ip-addresses">Jails Ip Addresses</a></li>
                
              
                  <li class="active"><a href="/finch/jails-ssh" class="active">Jails Ssh</a></li>
                
                
              
                
                  <li><a href="/finch/manpage">Manpage</a></li>
                
              
                
                  <li><a href="/finch/mounting-filesystems">Mounting Filesystems</a></li>
                
              
                
                  <li><a href="/finch/portsnap_override-8">Portsnap_override 8</a></li>
                
              
                
                  <li><a href="/finch/qjail-reference">Qjail Reference</a></li>
                
              
                
                  <li><a href="/finch/support">Support</a></li>
                
              
                
                  <li><a href="/finch/upgrading">Upgrading</a></li>
                
              
                
                  <li><a href="/finch/usage">Usage</a></li>
                
               -->
            </ul>
    
          <!-- </p> -->
          </div>
    
        <!-- </div> -->
      </div>
    </div>
    

    <div class="logo"></div>

    <div class="container-narrow">

      <div class="content">
        <h1 id="toc_0">Jails - Ssh</h1>

<p><ul>
<li>
<a href="#toc_0">Jails - Ssh</a>
</li>
<li>
<a href="#toc_1">4 ways to enable ssh</a>
<ul>
<li>
<a href="#toc_2">Terminal access via 'qjail console'</a>
</li>
<li>
<a href="#toc_3">Create a jail with ssh enabled</a>
<ul>
<li>
<a href="#toc_4">Part A - Create the jail</a>
</li>
<li>
<a href="#toc_5">Part B - Create an account for ssh'ing into your jail</a>
</li>
</ul>
</li>
<li>
<a href="#toc_6">Create a jail with ssh enabled for root</a>
</li>
<li>
<a href="#toc_7">Turn on ssh in an existing jail</a>
</li>
</ul>
</li>
</ul>
</p>

<p>This page explains how to enable ssh access for your jails. After enabling ssh access, a password login to your jails will be possible. The exception being the <a href="#toc_2"><code>qjail console</code></a> command which does not need any password.</p>

<p>To configure passwordless ssh access later on, please also check <strong><em><a href="http://www.commandlinefu.com/commands/view/188/copy-your-ssh-public-key-to-a-server-from-a-machine-that-doesnt-have-ssh-copy-id">these instructions</a></em></strong> on <a href="http://www.commandlinefu.com/commands/view/188/copy-your-ssh-public-key-to-a-server-from-a-machine-that-doesnt-have-ssh-copy-id">commandlinefu.com</a>. Where you can learn how to scp over ssh keys (<code>~/.ssh/id_rsa.pub</code>) and edit the <code>~/.ssh/authorized_keys</code> file.</p>

<h1 id="toc_1">4 ways to enable ssh</h1>

<p><strong><em><span class="mar">RECOMMENDED</span></em></strong></p>

<ul>
<li><p><a href="#toc_2">1. Terminal access via &#39;qjail console&#39;</a>.</p>

<p>your computer ---&gt; ssh ---&gt; FreeNAS / NAS4Free ---&gt; qjail console</p></li>
<li><p>Using either <a href="#toc_3">2. the <code>finch-ssh</code> jails template</a> or <a href="#toc_6">3. <code>finch-ssh-root</code> jail template</a>. (and <em>NOT</em> the one named &quot;ssh-default&quot;).</p></li>
</ul>

<p>The template &quot;finch-ssh&quot; will forbid root account ssh logins. Wheras &quot;finsh-ssh-root&quot; will permit ssh logins for all user accounts, inclusive of the <code>root</code> user.</p>

<ul>
<li><a href="#toc_7">4. Manually turn on ssh for an existing jail</a>. Because you might have already created your jail without the necessary ssh flavor, or have deferred the decision to switch on ssh until later on.</li>
</ul>

<p><strong><em><span class="mar">NOT RECOMMENDED</span></em></strong></p>

<ul>
<li>5. The template provided by qjail, labeled <code>ssh-default</code>. The method documented on the qjail manpage. That one is enabled by &quot;qjail create -c&quot;, or <code>qjail config -h</code>. <em>REASON:</em> we do not encourage it&#39;s use because you are forced into using a specific username for your ssh account. Finch installs for you better ssh templates (<a href="#toc_3">2.</a> and <a href="#toc_6">3.</a>), which improve control over which user accounts may be allowed to access your jails.</li>
</ul>

<h2 id="toc_2">Terminal access via &#39;qjail console&#39;</h2>

<p>By default ssh will not be enabled on that jail. SSh often isn&#39;t required because we can just ssh into the FreeBSD host machine then access any of our jails from the commandline.</p>

<p>The command <code>qjail console $jailname</code> will launch a root login shell and enter you into the chosen jail.</p>

<pre><code>ssh &quot;$freebsd_host&quot;
sudo qjail console &quot;$jailname&quot;
</code></pre>

<p>Or you may prefer to perform both actions together as a single step:</p>

<pre><code>ssh &quot;$freebsd_host&quot; sudo finch chroot qjail console &quot;$jailname&quot;
</code></pre>

<p>Which can be made into a simple <code>~/.profile</code> shell function, script or Windows batch file. It takes the jail&#39;s name as a parameter. For example:</p>

<pre><code>qjail-remote-console ()
{
  if [ &quot;$#&quot; -gt &quot;0&quot; ]; then
    # The freebsd system where finch and qjail are installed (FreeNAS / NAS4free)
    local freebsd_host=&quot;192.168.1.XXX&quot;

    ssh &quot;$freebsd_host&quot; sudo finch chroot qjail console &quot;$@&quot;

  else
    echo &quot;usage: qjail-remote-console $jailname&quot;
  fi
}
</code></pre>

<p><strong>Note:</strong> The <code>qjail console</code> command only provides a login for tty / terminal access. It does not enable ssh inside the jail. Almost all other ssh-based services are designed to connect to a real ssh daemon and won&#39;t work with this method. However you may feed multiple commands into the shell seesion in the following way:</p>

<pre><code>echo &quot;$some_cmd1; $some_cmd2&quot; | qjail-remote-console $jailname
</code></pre>

<h2 id="toc_3">Create a jail with ssh enabled</h2>

<p>This flavor does not permit ssh logins for the root account.</p>

<h3 id="toc_4">Part A - Create the jail</h3>

<pre><code># Enter the finch chroot environment, as root
sudo finch chroot

# Read the page &quot;jail-ip-addresses&quot; before choosing a jail IP address
jail_ip=&quot;192.168.1.202&quot;
jail_loopback=&quot;lo0|127.0.0.202&quot;

# Give an appropriate server name to your jail
jailname=&quot;ssh&quot;

# Create a jail with the &quot;finch-ssh&quot; flavor
qjail create -f finch-ssh -4 &quot;$jail_ip,$jail_loopback&quot; &quot;$jailname&quot;

# Enable unix sockets
qjail config -k &quot;$jailname&quot;

# Update local pkgng database, to avoid &#39;failed checksum&#39; for &#39;pkg install&#39;
pkg update -f

# Start the jail
qjail start &quot;$jailname&quot;
</code></pre>

<h3 id="toc_5">Part B - Create an account for ssh&#39;ing into your jail</h3>

<p>In the example below we assume that you want a wheel account to use for administering your jail. However superuser privileges are not a requirement for ssh&#39;ing. In which case just omit the <code>&quot;-G wheel&quot;</code> part to create a regular account.</p>

<pre><code># 1. Login locally (as root)
qjail console &quot;$jailname&quot;

# 2. Create an account
username=&quot;admin&quot; # put here your own username
pw user add &quot;$username&quot; -c &quot;$username&#39;s account&quot; -m -G wheel

# 3. Set a password. Otherwise we are not permitted to login over ssh
passwd &quot;$username&quot;
exit

# Test the connection - ssh into the jail
username=&quot;admin&quot; # put again your chosen username
ssh &quot;${username}@${jail_ip}&quot;
</code></pre>

<h2 id="toc_6">Create a jail with ssh enabled for root</h2>

<p>This flavor does permit ssh logins for the <code>root</code> account. And regular users too.</p>

<pre><code># Enter the finch chroot environment, as root
sudo finch chroot

# Read the page &quot;jail-ip-addresses&quot; before choosing a jail IP address
jail_ip=&quot;192.168.1.203&quot;
jail_loopback=&quot;lo0|127.0.0.203&quot;

# Give an appropriate server name to your jail
jailname=&quot;root-ssh&quot;

# Create a jail with the &quot;finch-ssh-root&quot; flavor
qjail create -f finch-ssh-root -4 &quot;$jail_ip,$jail_loopback&quot; &quot;$jailname&quot;

# Enable unix sockets
qjail config -k &quot;$jailname&quot;

# Update local pkgng database, to avoid &#39;failed checksum&#39; for &#39;pkg install&#39;
pkg update -f

# Start the jail
qjail start &quot;$jailname&quot;

# Set a password. Otherwise we are not permitted to login over ssh
qjail console &quot;$jailname&quot;
passwd &quot;root&quot;
exit

# Test the connection - ssh into the jail
username=&quot;root&quot; # put again your chosen username
ssh &quot;${username}@${jail_ip}&quot;
</code></pre>

<h2 id="toc_7">Turn on ssh in an existing jail</h2>

<p>For an existing jail, we can manually copy over the same ssh configuration files, as would have been used in creating a new jail.</p>

<pre><code># Set to the name of your existing jail
jailname=&quot;nginx&quot;

# 1. Either forbid the root account to have ssh access
cp -Rf &quot;/usr/jails/flavors/finch-ssh/etc/ssh&quot; &quot;/usr/jails/${jailname}/etc/&quot;

# 2. Or permit the root account to have ssh access
cp -Rf &quot;/usr/jails/flavors/finch-ssh-root/etc/ssh&quot; &quot;/usr/jails/${jailname}/etc/&quot;

# Edit the jail&#39;s rc.conf file to enable the ssh daemon
sysrc -f &quot;/usr/jails/${jailname}/etc/rc.conf&quot; &quot;sshd_enable=YES&quot;

# Make sure you have created your chosen ssh login accounts.
# You must also set a password as per the previous the example(s) above ^^

# Restart the jail - to start the ssh daemon
qjail restart &quot;$jailname&quot;

# Test the connection - ssh into the jail
username=&quot;root&quot; # put again your chosen username
ssh &quot;${username}@${jail_ip}&quot;
</code></pre>

      </div>

      <!-- last linebreak for manpage -->
      <p style="line-height: 0px;">&nbsp;</p> 

      <div class="footer">
        <hr class="footer-hr">
      
        <!-- order is backwards b/c footer-left style isnt loaded -->
        <div class="footer-left" style="float: left; position: absolute;">
          <!-- Project hosted on Github <a href="https://github.com/dreamcat4/finch">dreamcat4/finch</a> -->
          Project hosted on Github @ <a href="https://github.com/dreamcat4/finch">dreamcat4/finch</a>.
        </div>
        <div class="footer-right" style="float: right; position: relative;">
          &copy; Dreamcat4 2014, 
           FreeBSD License.
        </div>
      
        <div style="clear: both;"></div>​
      </div>
      

    </div> <!-- /container -->

    <!-- Google Prettify -->
<script src="http://cdnjs.cloudflare.com/ajax/libs/prettify/188.0.0/prettify.js"></script>
<script>
  var pres = document.getElementsByTagName("pre");
  for (var i=0; i < pres.length; ++i) {
    pres[i].className = "prettyprint ";
  }
  prettyPrint();
</script>
<!-- end Google Prettify -->
    
    
  </body>
</html>
