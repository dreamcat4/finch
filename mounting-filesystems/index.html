<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Finch - Mounting Filesystems</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="author" content="Dreamcat4">

    <!-- Le HTML5 shim, for IE6-8 support of HTML elements -->
    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <!-- google_prettify/sons-of-obsidian.css -->
    <!-- google_prettify/desert.css -->
    <!-- google_prettify/sunburst.css -->
    <!-- google_prettify/twitter-bootstrap.css -->
    <!-- google_prettify/default.css -->

<link href='/finch/assets/stylesheets/bootstrap.min-5534befd4bd1fd0a071242cecfe33975.css' type='text/css' rel='stylesheet' media='all'>
<link href='/finch/assets/stylesheets/poole-3c3695b40c100cdb0e4db7753b840b57.css' type='text/css' rel='stylesheet' media='all'>
<link href='/finch/assets/stylesheets/style-cf56b256a9bd3b065ef200cb5c12edb6.css' type='text/css' rel='stylesheet' media='all'>
<link href='/finch/assets/stylesheets/google_prettify/default-twitter-merge-fba10b1d8b0c64b52b9995d391059367.css' type='text/css' rel='stylesheet' media='all'>
    <!-- Favicon and touch icons -->
    <link rel="shortcut icon" href="/finch/assets/media/favicon.ico">
    <!-- <link rel="apple-touch-icon" href="media/apple-touch-icon.png"> -->
    <!-- <link rel="apple-touch-icon" sizes="72x72" href="media/apple-touch-icon-72x72.png"> -->
    <!-- <link rel="apple-touch-icon" sizes="114x114" href="media/apple-touch-icon-114x114.png"> -->
 
  </head>

  <body class="theme-base-08">

    <div class="sidebar">
      <div class="container sidebar-sticky">
    
        <div class="sidebar-about">
    
              <h1 style="margin-bottom: -10px;">
                <a class="sidebar-nav-item" href="/finch">Finch</a>
              </h1>
    
          <!-- <p class="lead">FreeBSD... in a chroot!</p> -->
    
          <p class="lead">Freebsd... <strong><i>in a chroot!</i></strong></p>
          <!-- <p class="lead">Freebsd <strong><i>in a chroot!</i></strong></p> -->
    
          <!-- <div class="lead">Freebsd... <strong></div>
            <div class="lead"><i>&nbsp&nbsp&nbsp&nbsp&nbspin a chroot!</i></strong></div> -->
    
        </div>
    
        <ul class="sidebar-nav">
    
                <li class="sidebar-nav-item"><a href="/finch/install">Install</a></li>
                <li class="sidebar-nav-item"><a href="/finch/usage">Usage</a></li>
                <li class="sidebar-nav-item"><a href="/finch/manpage">Manpage</a></li>
                <li class="sidebar-nav-item"><a href="/finch/faq">FAQ</a></li>
                <li class="sidebar-nav-item"><a href="/finch/jails-how-to">Jails How To</a></li>
                <li class="sidebar-nav-item"><a href="/finch/jails-ip-addresses">Jails Ip Addresses</a></li>
                <li class="sidebar-nav-item"><a href="/finch/jails-ssh">Jails Ssh</a></li>
                <li>
                  <a href="/finch/mounting-filesystems" class="sidebar-nav-item-active">Mounting Filesystems</a>
                </li>
                <li class="sidebar-nav-item"><a href="/finch/qjail-reference">Qjail Reference</a></li>
                <li class="sidebar-nav-item"><a href="/finch/upgrading">Upgrading</a></li>
                <li class="sidebar-nav-item"><a href="/finch/support">Support</a></li>
    
              <!-- <li><a href="/finch/faq">FAQ</a></li> -->
              <!-- <li class="sidebar-nav-item"><a href="/finch/faq">FAQ</a></li> -->
              <!-- <li><a href="/finch/finch-8">Finch 8</a></li> -->
              <!-- <li class="sidebar-nav-item"><a href="/finch/finch-8">Finch 8</a></li> -->
              <!-- <li><a href="/finch">Index</a></li> -->
              <!-- <li class="sidebar-nav-item"><a href="/finch">Index</a></li> -->
              <!-- <li><a href="/finch/install">Install</a></li> -->
              <!-- <li class="sidebar-nav-item"><a href="/finch/install">Install</a></li> -->
              <!-- <li><a href="/finch/jails-how-to">Jails How To</a></li> -->
              <!-- <li class="sidebar-nav-item"><a href="/finch/jails-how-to">Jails How To</a></li> -->
              <!-- <li><a href="/finch/jails-ip-addresses">Jails Ip Addresses</a></li> -->
              <!-- <li class="sidebar-nav-item"><a href="/finch/jails-ip-addresses">Jails Ip Addresses</a></li> -->
              <!-- <li><a href="/finch/jails-ssh">Jails Ssh</a></li> -->
              <!-- <li class="sidebar-nav-item"><a href="/finch/jails-ssh">Jails Ssh</a></li> -->
              <!-- <li><a href="/finch/manpage">Manpage</a></li> -->
              <!-- <li class="sidebar-nav-item"><a href="/finch/manpage">Manpage</a></li> -->
              <!-- <li class="active"><a href="/finch/mounting-filesystems" class="active">Mounting Filesystems</a></li> -->
              <!-- <li class="sidebar-nav-item-active"> -->
              <!-- <li>
                <a href="/finch/mounting-filesystems" class="sidebar-nav-item-active">Mounting Filesystems</a>
              </li> -->
              <!-- <li><a href="/finch/portsnap_override-8">Portsnap_override 8</a></li> -->
              <!-- <li class="sidebar-nav-item"><a href="/finch/portsnap_override-8">Portsnap_override 8</a></li> -->
              <!-- <li><a href="/finch/qjail-reference">Qjail Reference</a></li> -->
              <!-- <li class="sidebar-nav-item"><a href="/finch/qjail-reference">Qjail Reference</a></li> -->
              <!-- <li><a href="/finch/support">Support</a></li> -->
              <!-- <li class="sidebar-nav-item"><a href="/finch/support">Support</a></li> -->
              <!-- <li><a href="/finch/upgrading">Upgrading</a></li> -->
              <!-- <li class="sidebar-nav-item"><a href="/finch/upgrading">Upgrading</a></li> -->
              <!-- <li><a href="/finch/usage">Usage</a></li> -->
              <!-- <li class="sidebar-nav-item"><a href="/finch/usage">Usage</a></li> -->
    
              <!-- <a href="https://github.com/dreamcat4/finch/issues">Bugtracker</a> -->
    
                <!-- <li class="sidebar-nav-item{% if page.url == node.url %} active{% endif %}"> -->
    
    
    
                  <!-- <a href=""></a> -->
    
                  <!-- 
                    
                      <li><a href="/finch/faq">FAQ</a></li>
                    
                  
                    
                      <li><a href="/finch/finch-8">Finch 8</a></li>
                    
                  
                    
                      <li><a href="/finch">Index</a></li>
                    
                  
                    
                      <li><a href="/finch/install">Install</a></li>
                    
                  
                    
                      <li><a href="/finch/jails-how-to">Jails How To</a></li>
                    
                  
                    
                      <li><a href="/finch/jails-ip-addresses">Jails Ip Addresses</a></li>
                    
                  
                    
                      <li><a href="/finch/jails-ssh">Jails Ssh</a></li>
                    
                  
                    
                      <li><a href="/finch/manpage">Manpage</a></li>
                    
                  
                      <li class="active"><a href="/finch/mounting-filesystems" class="active">Mounting Filesystems</a></li>
                    
                    
                  
                    
                      <li><a href="/finch/portsnap_override-8">Portsnap_override 8</a></li>
                    
                  
                    
                      <li><a href="/finch/qjail-reference">Qjail Reference</a></li>
                    
                  
                    
                      <li><a href="/finch/support">Support</a></li>
                    
                  
                    
                      <li><a href="/finch/upgrading">Upgrading</a></li>
                    
                  
                    
                      <li><a href="/finch/usage">Usage</a></li>
                    
                   -->
    
    
                </li>
              <!-- {% endif %}
            {% endif %}
          {% endfor %} -->
    
          <!-- <li class="sidebar-nav-item"><a href="dreamcat4/finch/archive/v.zip">Download</a></li> -->
          <!-- <li class="sidebar-nav-item"><a href="https://github.com/dreamcat4/finch">GitHub Project</a></li> -->
          <!-- <li class="sidebar-nav-item">Currently v</li> -->
    
          <!-- <li class="sidebar-nav-item"><a href="https://github.com/dreamcat4/finch">GitHub Project</a></li> -->
          
          <p></p>
          <!-- <p></p> -->
        </ul>
        <!-- <p> -->
        <p>
          <!-- <class="crumbline" style="color: #515151; font-size: 16px; font-style: italic; font-weight: 400;" href="https://github.com/dreamcat4/finch">GitHub Project</a> -->
          <!-- <a class="sidebar-nav" class="crumbline" style="color: #515151; font-size: 16px; font-style: italic; font-weight: 400;" href="https://github.com/dreamcat4/finch">GitHub Project</a> -->
    
          <!-- <a class="sidebar-nav" class="crumbline" style="color: #515151; font-size: 16px; font-style: italic; font-weight: 400;" href="#toc_0">Back to Top</a> -->
    
          <a class="sidebar-nav" class="crumbline" style="color: #515151; font-size: 16px; font-style: italic; font-weight: 400;" href="/finch/mounting-filesystems">Back to Top</a>
    
          <!-- © 2014. All rights reserved. -->
        </p>
    
        <!-- <p>&copy; {--{ site.time | date: '%Y' }--}. All rights reserved.</p> -->
      </div>
    </div>
    

    <div class="navbar">
      <div class="navbar-inner">
        <!-- <div class="container-narrow"> -->
          <!-- <a class="brand" href="/finch/">Finch</a> -->
    
          <!-- <p class="navbar-left"> -->
          <div class="navbar-left">
    
            <!-- Project hosted on Github <a href="https://github.com/dreamcat4/finch">dreamcat4/finch</a> -->
    
            <ul class="nav">
                  <li><a href="/finch">Home</a></li>
    
                
                  <li><a href="/finch/manpage">Manpage</a></li>
                
                
                  <li><a href="/finch/install">Install</a></li>
                
                
                  <li><a href="/finch/faq">FAQ</a></li>
                
    
            </ul>
    
          <!-- </p> -->
          </div>
    
    
          <!-- <p class="footer-center">
          </p> -->
    
          <!-- <p class="navbar-right"> -->
          <div class="navbar-right">
    
            <!-- &copy; Dreamcat4 2014,  -->
            <!-- FreeBSD Licensing terms. -->
    
    
            <ul class="nav">
    
                
                  <li><a href="/finch/jails-how-to">Jails How To</a></li>
                
                
                  <li><a href="/finch/upgrading">Upgrading</a></li>
                
                
                  <li><a href="/finch/support">Support</a></li>
                
    
              <!--  -->
    
              <!-- 
                
                  <li><a href="/finch/faq">FAQ</a></li>
                
              
                
                  <li><a href="/finch/finch-8">Finch 8</a></li>
                
              
                
                  <li><a href="/finch">Index</a></li>
                
              
                
                  <li><a href="/finch/install">Install</a></li>
                
              
                
                  <li><a href="/finch/jails-how-to">Jails How To</a></li>
                
              
                
                  <li><a href="/finch/jails-ip-addresses">Jails Ip Addresses</a></li>
                
              
                
                  <li><a href="/finch/jails-ssh">Jails Ssh</a></li>
                
              
                
                  <li><a href="/finch/manpage">Manpage</a></li>
                
              
                  <li class="active"><a href="/finch/mounting-filesystems" class="active">Mounting Filesystems</a></li>
                
                
              
                
                  <li><a href="/finch/portsnap_override-8">Portsnap_override 8</a></li>
                
              
                
                  <li><a href="/finch/qjail-reference">Qjail Reference</a></li>
                
              
                
                  <li><a href="/finch/support">Support</a></li>
                
              
                
                  <li><a href="/finch/upgrading">Upgrading</a></li>
                
              
                
                  <li><a href="/finch/usage">Usage</a></li>
                
               -->
            </ul>
    
          <!-- </p> -->
          </div>
    
        <!-- </div> -->
      </div>
    </div>
    

    <div class="logo"></div>

    <div class="container-narrow">

      <div class="content">
        <h1 id="toc_0">Mounting filesystems</h1>

<p><ul>
<li>
<a href="#toc_0">Mounting filesystems</a>
<ul>
<li>
<a href="#toc_1">The Nullfs restriction</a>
<ul>
<li>
<a href="#toc_2">The Solution</a>
</li>
</ul>
</li>
</ul>
</li>
<li>
<a href="#toc_3">Example</a>
<ul>
<li>
<a href="#toc_4">Zfs</a>
<ul>
<li>
<a href="#toc_5">Existing dataset</a>
</li>
<li>
<a href="#toc_6">New dataset</a>
</li>
<li>
<a href="#toc_7">Jail - fstab</a>
</li>
<li>
<a href="#toc_8">Jail - sharedfs mount</a>
</li>
</ul>
</li>
<li>
<a href="#toc_9">Non-zfs</a>
</li>
<li>
<a href="#toc_10">Finch's fstab</a>
</li>
</ul>
</li>
</ul>
</p>

<h2 id="toc_1">The Nullfs restriction</h2>

<p>The restriction: <em>you can&#39;t <code>mount_nullfs</code> twice in a row !</em> It&#39;s because...</p>

<ul>
<li>FreeBSD&#39;s implementation of nullfs only ever creates a single-layer overlay. Therefore it is not possible to stack multiple nullfs layers on top of each other.</li>
<li>In other words, it&#39;s not possible to daisy-chain nullfs mounts.</li>
<li>You will acutally be mounting whatever was previously underneath it (usually an empty directory).</li>
<li>If you have nullfs mounted some toplevel (global host folder) into finch&#39;s chroot, then for example, a jail fstab entry inside finch cannot pick it up.</li>
<li>The restriction rears it&#39;s head because typically we want to mirror some of our data that available on the host system into the Finch subdirectory (by using nullfs). Then in turn from within Finch into our guest jails. Making then a second layer of indirection (which we can&#39;t have).</li>
</ul>

<h3 id="toc_2">The Solution</h3>

<p>For a trouble-free life, please follow these steps when mounting your user data:</p>

<ul>
<li>Unmount your data from it&#39;s existing mountpoint on the host system.</li>
<li>Directly mount your user data into a location inside the Finch chroot. For example:</li>
</ul>

<pre><code>    $finch_realpath/mnt/my_data
    $finch_realpath/usr/jails/sharedfs/my_data
</code></pre>

<ul>
<li>Make a <code>nullfs</code> mapping from the new location inside Finch ---&gt; back to outside where the folders previously used to be.</li>
<li>Add a nullfs entry to your jail&#39;s fstab file <a href="#toc_8">as decribed later on</a> to also mapthe data into your jail(s).<sup>1</sup></li>
</ul>

<p>You should end up with:</p>

<pre><code>HOST (nullfs mappings) &lt;---- FINCH (your data is mounted here) ----&gt; JAILS (nullfs mappings)
</code></pre>

<p>It might seem a little odd, but the best place to mount your user data folders is somewhere inside the Finch chroot. Being located in the middle means that it can be seen from either side of the fence.</p>

<p><sup>1</sup> Not necessary for mounts within <code>usr/jails/sharedfs</code>, which is automatically mounted into <em>all jails</em>. More information <a href="#toc_9">here</a>.</p>

<h1 id="toc_3">Example</h1>

<h2 id="toc_4">Zfs</h2>

<p>In this following example, we show you how to mount or remount zfs partitions (a.k.a. &quot;datasets&quot;). All of our datasets are on one single zfs pool, shown here as <code>disk0</code>, and with no altroot setting (<code>altroot=&#39;/&#39;</code>).</p>

<h3 id="toc_5">Existing dataset</h3>

<p>Let us suppose we already have an existing dataset, named <code>my_dataset</code>. OR we can find out a dataset&#39;s name and current mountpoint with the <code>zfs list</code> command:</p>

<pre><code>$ zfs list
NAME                                      USED  AVAIL  REFER  MOUNTPOINT
disk0                                    68.9G   616G  67.1G  /mnt/disk0
disk0/my_dataset                          144K   616G   144K  /mnt/disk0/my_dataset
</code></pre>

<p>If we have:</p>

<pre><code>finch_realpath=&quot;/mnt/disk0/finch&quot; # &lt;---- our finch chroot
zfspool=&quot;disk0&quot;                   # &lt;---- our zfs pool
dataset=&quot;disk0/my_dataset&quot;        # &lt;---- our zfs dataset
</code></pre>

<p>Firstly, make sure you are <em>outside</em> of the finch chroot. Then get your <code>/path/to/finch</code> with this command:</p>

<pre><code>finch_realpath=&quot;$(finch realpath)&quot;
</code></pre>

<p>We can move our dataset&#39;s mountpoint to be inside of our Finch chroot:</p>

<pre><code>zfs set mountpoint=&quot;${finch_realpath}/mnt/disk0/my_dataset&quot; &quot;$dataset&quot;
</code></pre>

<p>We can also put back (replace) the previous mountpoint so it&#39;s the same as before:</p>

<pre><code>mkdir -p /mnt/disk0/my_dataset
mount_nullfs &quot;${finch_realpath}/mnt/disk0/my_dataset&quot; &quot;/mnt/disk0/my_dataset&quot; 
</code></pre>

<h3 id="toc_6">New dataset</h3>

<p>For a new dataset, we do almost exactly the same as &quot;existing dataset&quot; situation above. Except for this part:</p>

<pre><code>dataset=&quot;disk0/new_dataset&quot;
zfs create &quot;$dataset&quot;
zfs set mountpoint=&quot;${finch_realpath}/mnt/${dataset}&quot; &quot;$dataset&quot;
</code></pre>

<h3 id="toc_7">Jail - fstab</h3>

<p>Now we can add the dataset to our jail&#39;s fstab file</p>

<pre><code>jailname=&quot;my_jail&quot;   # &lt;---- The name of our jail

# Stop the jail
finch qjail stop &quot;$jailname&quot;

# Create an emtpy folder where we will nullfs mount our data
mkdir -p &quot;${finch_realpath}/usr/jails/${jailname}/mnt/${dataset}&quot;

# Edit the jail&#39;s fstab file in a text editor...
nano &quot;${finch_realpath}/usr/local/etc/qjail.fstab/${jailname}&quot;

# ...and add the following line (not the &gt;&gt;&gt; arrows!)
&gt;&gt;&gt;
/mnt/$dataset /usr/jails/my_jail/mnt/$dataset nullfs ro 0 0
&gt;&gt;&gt;

# Start the jail
finch qjail start &quot;$jailname&quot;

# Check that it mounted
df
</code></pre>

<h3 id="toc_8">Jail - sharedfs mount</h3>

<p>Qjail mounts one special folder, sharedfs as read-only inside all of your jails. So if you wish you may create additional folder(s) inside the directory /usr/jails/sharedfs and that user data can be seen (read-only) inside all of your jails.</p>

<p>So what if you have a data partition which you want to share amongst ALL of your jails?</p>

<p>Unfortunately it is the case that mount_nullfs does not traverse filesystem boundaries and therefore you cannot place mounts inside the sharedfs folder and see them from inside the jail&#39;s perspective. The folders do not remap. So you will need to create individual fstab entries for each folder, in each jail&#39;s fstab file where you wish to mount them. (as per the previous section).</p>

<h2 id="toc_9">Non-zfs</h2>

<p>Let us suppose you have a FAT32, NTFS, or EXT (linux) data partition. Follow the above ZFS steps. But don&#39;t issue any zfs commands. Whenever you hit a zfs command <em>perform an equivalent step</em>. Use the same paths / locations as in the zfs guide.</p>

<ul>
<li>In FreeNAS and FreeBSD-GENERIC, edit the global <code>/etc/fstab</code>.</li>
<li>In NAS4Free, navigate to <code>Disks | Mount Point | Management</code> in the Web GUI.</li>
</ul>

<h2 id="toc_10">Finch&#39;s fstab</h2>

<p>Finch does also have it&#39;s own <code>fstab</code> file should you feel inclined to use it. However it is not usually necessary since your host system already has it&#39;s own fstab file or equivalent mechanism.</p>

<ul>
<li>Located at <code>$finch_realpath/etc/fstab</code>.</li>
<li>Works just the same as your host&#39;s <code>/etc/fstab</code> file.</li>
<li>Mounts can be from and disks or folders available on the host system. Toplevel / global scope.</li>
<li>Fstab entries will be mounted just before <code>finch start</code> and unmounted after <code>finch stop</code>.</li>
</ul>

      </div>

      <!-- last linebreak for manpage -->
      <p style="line-height: 0px;">&nbsp;</p> 

      <div class="footer">
        <hr class="footer-hr">
      
        <!-- order is backwards b/c footer-left style isnt loaded -->
        <div class="footer-left" style="float: left; position: absolute;">
          <!-- Project hosted on Github <a href="https://github.com/dreamcat4/finch">dreamcat4/finch</a> -->
          Project hosted on Github @ <a href="https://github.com/dreamcat4/finch">dreamcat4/finch</a>.
        </div>
        <div class="footer-right" style="float: right; position: relative;">
          &copy; Dreamcat4 2014, 
           FreeBSD License.
        </div>
      
        <div style="clear: both;"></div>​
      </div>
      

    </div> <!-- /container -->

    <!-- Google Prettify -->
<script src="http://cdnjs.cloudflare.com/ajax/libs/prettify/188.0.0/prettify.js"></script>
<script>
  var pres = document.getElementsByTagName("pre");
  for (var i=0; i < pres.length; ++i) {
    pres[i].className = "prettyprint ";
  }
  prettyPrint();
</script>
<!-- end Google Prettify -->
    
    
  </body>
</html>
